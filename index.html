<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resonance RPG -Mobile Optimized-</title>
    <style>
        :root { --bg: #0a0a0c; --owen: #a335ee; --cain: #f1c40f; --hp: #e74c3c; --panel: #1a1a20; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg); color: #dcdde1; font-family: sans-serif; 
            display: flex; flex-direction: column; 
            height: 100dvh; width: 100vw; overflow: hidden;
            padding: 10px;
        }
        
        /* 1. 上部：ミッション */
        .m-hdr { flex-shrink: 0; background: #000; border: 1px solid var(--cain); padding: 8px; border-radius: 4px; margin-bottom: 8px; text-align: center; }
        .m-idx { font-size: 13px; font-weight: bold; color: var(--cain); display: block; }
        .achieved { background: var(--cain) !important; color: #000 !important; }

        /* 2. ステータス：極限までシンプルに */
        .st-bar { flex-shrink: 0; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #111; padding: 6px; border-radius: 4px; }
        .c-lbl { font-size: 11px; font-weight: bold; color: var(--cain); }
        .bar-wrap { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .bg-b { background: #222; height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        #h-fill { background: var(--hp); height: 100%; transition: width 0.3s; }
        #m-fill { background: #3498db; height: 100%; transition: width 0.3s; }
        
        /* 3. 距離表示 */
        .d-ui { flex-shrink: 0; font-size: 11px; text-align: center; margin-bottom: 8px; color: #aaa; }

        /* 4. ログ */
        #log { 
            flex-grow: 1; overflow-y: auto; background: #000; border: 1px solid #222; 
            border-radius: 4px; padding: 12px; font-size: 13px; line-height: 1.6; margin-bottom: 10px;
        }
        .log-owen { color: var(--owen); font-weight: bold; }
        .log-dmg { color: #ff7675; } 
        .log-sys { color: #888; font-size: 11px; margin-top: 4px; border-top: 1px solid #111; padding-top: 2px; }

        /* 5. 下部：3つのメインボタン */
        .btns { flex-shrink: 0; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        button { 
            background: #252e38; color: #fff; border: 1px solid #444; padding: 10px 4px; 
            border-radius: 6px; font-size: 12px; font-weight: bold; min-height: 54px; cursor: pointer; 
        }
        button:active { background: #1a252f; border-color: var(--cain); }
        #btn-boss { background: #633277; grid-column: span 3; display: none; margin-bottom: 8px; }
        #btn-inn { background: #2c3e50; border-color: var(--cain); grid-column: span 3; display: none; margin-bottom: 8px; }

        /* 6. アイテムモーダル */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background: var(--panel); border: 1px solid #444; width: 85%; padding: 20px; border-radius: 8px;
        }
        .m-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    </style>
</head>
<body>

    <div class="m-hdr" id="m-box">
        <span class="m-idx">目的：古い銀貨を3枚持ち帰れ</span>
        <div style="font-size:10px" id="m-count">0 / 3 (未達成)</div>
    </div>

    <div class="st-bar">
        <span class="c-lbl">CAIN</span>
        <div class="bar-wrap">
            <div class="bg-b"><div id="h-fill" style="width: 100%;"></div></div>
            <div class="bg-b"><div id="m-fill" style="width: 100%;"></div></div>
        </div>
    </div>

    <div class="d-ui" id="dist-ui">宿屋まで: 0km / 目的地まで: 10km</div>

    <div id="log"></div>

    <button id="btn-boss" onclick="act('boss')">深部に潜む影と対峙する</button>
    <button id="btn-inn" onclick="act('inn')">宿屋の暖簾を潜る</button>

    <div class="btns">
        <button id="btn-fwd" onclick="act('fwd')">進む</button>
        <button id="btn-bwd" onclick="act('bwd')">戻る</button>
        <button onclick="toggleModal(true)">アイテム</button>
    </div>

    <div id="modal" onclick="toggleModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="color:var(--cain); margin-bottom:15px; border-bottom:1px solid var(--cain);">探索状況・所持品</h3>
            <div class="m-row"><span>手荷物（銀貨）</span><span id="mdl-t">0</span></div>
            <div class="m-row"><span>倉庫の蓄え</span><span id="mdl-g">0</span></div>
            <div class="m-row"><span>甘味の残り</span><span id="mdl-sw">0</span></div>
            <div class="m-row"><span>カインの撃破数</span><span id="mdl-k">0</span></div>
            <div class="m-row"><span>オーエンの撃破数</span><span id="mdl-o">0</span></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button onclick="act('eat')" style="min-height:40px; background:#4a3c28;">甘味を消費</button>
                <button onclick="toggleModal(false)" style="min-height:40px;">閉じる</button>
            </div>
        </div>
    </div>

<script>
window.onload = function() {
    let st = { 
        c_h: 120, c_mh: 120, c_m: 50, c_mm: 50, 
        gInv: 0, tInv: 0, sw: 3, 
        dist: 10, // 10=宿屋, 0=目的地
        kainKills: 0, owenKills: 0
    };

    window.toggleModal = (show) => {
        document.getElementById('mdl-t').innerText = st.tInv;
        document.getElementById('mdl-g').innerText = st.gInv;
        document.getElementById('mdl-sw').innerText = st.sw;
        document.getElementById('mdl-k').innerText = st.kainKills;
        document.getElementById('mdl-o').innerText = st.owenKills;
        document.getElementById('modal').style.display = show ? 'flex' : 'none';
    };

    function ui() {
        document.getElementById('h-fill').style.width = (st.c_h / st.c_mh * 100) + "%";
        document.getElementById('m-fill').style.width = (st.c_m / st.c_mm * 100) + "%";
        
        const toInn = 10 - st.dist;
        const toDest = st.dist;
        document.getElementById('dist-ui').innerText = `宿屋まで: ${toInn}km / 目的地まで: ${toDest}km`;

        document.getElementById('btn-boss').style.display = (st.dist === 0) ? "block" : "none";
        document.getElementById('btn-fwd').disabled = (st.dist === 0);
        document.getElementById('btn-bwd').style.display = (st.dist === 10) ? "none" : "block";
        document.getElementById('btn-inn').style.display = (st.dist === 10) ? "block" : "none";

        const ready = (st.gInv >= 3);
        document.getElementById('m-count').innerText = `進行状況: ${st.gInv} / 3 (${ready ? '報告可能' : '未達成'})`;
        document.getElementById('m-box').className = ready ? "m-hdr achieved" : "m-hdr";
    }

    window.act = function(type) {
        if(st.c_h <= 0 && type !== 'inn') return;
        const log = document.getElementById('log');
        const add = (txt, cls="") => {
            const d = document.createElement('div'); if(cls) d.className = cls;
            d.innerHTML = txt; log.appendChild(d); log.scrollTop = log.scrollHeight;
        };

        if(type === 'fwd' || type === 'bwd') {
            const move = Math.random() > 0.5 ? 2 : 1;
            if(type === 'fwd') st.dist = Math.max(0, st.dist - move);
            else st.dist = Math.min(10, st.dist + move);
            
            add(type === 'fwd' ? `${move}km、深部へと潜り込んだ。` : `${move}km、宿屋への道を引き返した。`);

            if(Math.random() < 0.45) {
                const isOwen = Math.random() > 0.5;
                if(isOwen) {
                    st.owenKills++;
                    add("<span class='log-owen'>【オーエン】</span>気怠げに振られた指先から、紫の閃光が魔物を塵に変えた。", "log-owen");
                } else {
                    st.kainKills++;
                    add("カインの剣撃が魔物の核を的確に断ち割った。");
                }

                if(Math.random() < 0.5) {
                    st.c_h -= 15;
                    add(`魔物の死に際の抵抗。カインが盾となり衝撃を殺した。`, "log-dmg");
                    if(st.c_h <= 0) {
                        add("【敗走】カインの意識が途切れた。全てを失い、宿屋へ運び込まれた。", "log-dmg");
                        st.dist = 10; st.tInv = 0; st.c_h = 10;
                    } else {
                        st.tInv++; add("[古い銀貨]を回収。", "log-sys");
                    }
                }
            }
        } else if(type === 'boss') {
            st.owenKills++;
            add("<span class='log-owen'>【オーエン】</span>「……目障りだ」 紫の炎が深部の闇を焼き払い、静寂が戻った。", "log-owen");
            st.dist = 2; 
        } else if(type === 'eat') {
            if(st.sw > 0) { 
                st.sw--; st.c_m = st.c_mm; 
                add("オーエンは菓子を咀嚼し、わずかに退屈を紛らわせた。");
                toggleModal(false);
            }
        } else if(type === 'inn') {
            st.gInv += st.tInv;
            const total = st.kainKills + st.owenKills;
            add(`【帰還】精算完了。今回の総撃破数: ${total} (カイン: ${st.kainKills} / オーエン: ${st.owenKills})`, "log-sys");
            st.tInv = 0; st.c_h=st.c_mh; st.c_m=st.c_mm; st.sw=3;
            st.kainKills = 0; st.owenKills = 0;
        }
        ui();
    };
    ui();
};
</script>
</body>
</html>