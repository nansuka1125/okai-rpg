<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RPG_UI_Base</title>
    <style>
        /* --- CSS変数定義: 定数管理 --- */
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --accent-purple: #a333c8;
            --hp-red: #ff4d4d;
            --ui-bg: #1a1a1a;
            --border-color: #333333;
            --modal-overlay: rgba(0, 0, 0, 0.9);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* --- 基本レイアウト設定 --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100%;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        /* --- ヘッダー・ステータス --- */
        #chapterHeader {
            flex: 0 0 35px;
            background: #000;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #888;
            padding-top: env(safe-area-inset-top);
        }

        header {
            flex: 0 0 auto;
            padding: 12px 15px 8px;
            background: var(--ui-bg);
        }

        .status-info {
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .hp-bar-bg {
            width: 100%;
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
        }

        .hp-bar-fill {
            width: 100%;
            height: 100%;
            background: var(--hp-red);
            transition: width 0.3s ease;
        }

        /* --- プログレスライン --- */
        #progressContainer {
            background: var(--ui-bg);
            padding: 5px 15px 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #aaa;
            margin-bottom: 4px;
        }

        .progress-track {
            position: relative;
            width: 100%;
            height: 2px;
            background: #444;
        }

        #progressMarker {
            position: absolute;
            top: 50%;
            left: 0%;
            width: 10px;
            height: 10px;
            background: var(--text-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.3s ease;
        }

        /* --- ロケーション表示 --- */
        #locationBar {
            background: #111;
            padding: 10px 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- ログエリア --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .log-entry {
            font-size: 16px;
            line-height: 1.6;
        }

        .log-marker { color: #888; font-weight: bold; }

        /* --- 特殊アクションエリア (ログ直下、フッター直上へ移動) --- */
        #specialActionContainer {
            flex: 0 0 auto;
            background: var(--ui-bg);
            padding: 0;
            display: none;
            border-top: 1px solid var(--border-color);
        }

        .special-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-purple);
            color: white;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .special-btn:disabled {
            background: #444;
            color: #888;
        }

        /* --- 操作エリア --- */
        footer {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px 10px calc(10px + var(--safe-area-bottom));
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 8px;
        }

        .btn {
            height: 54px;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:disabled { opacity: 0.25; }

        /* --- アイテムモーダル --- */
        #itemModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay);
            z-index: 9999;
            justify-content: center; align-items: center; padding: 20px;
        }

        .modal-content {
            background: var(--ui-bg);
            border: 1px solid #444;
            border-radius: 12px; width: 100%; max-width: 400px;
            display: flex; flex-direction: column;
        }

        .item-list-container {
            padding: 10px; max-height: 40vh; overflow-y: auto;
        }

        .item-row {
            padding: 15px; border: 1px solid #333; margin-bottom: 8px;
            border-radius: 8px; background: #222; cursor: pointer;
        }

        .item-detail-area {
            padding: 15px; border-top: 1px solid #333; text-align: center;
            background: #111; min-height: 100px;
        }
    </style>
</head>
<body>

    <div id="chapterHeader">Chapter 1 銀貨と宿屋</div>

    <header>
        <div id="statusInfo" class="status-info">カイン Lv.1 [ 100 / 100 ]</div>
        <div class="hp-bar-bg"><div id="hpFill" class="hp-bar-fill"></div></div>
    </header>

    <div id="progressContainer">
        <div class="progress-labels">
            <span>宿屋</span>
            <span id="progressText">( 0 / 10m )</span>
            <span>森の深層</span>
        </div>
        <div class="progress-track"><div id="progressMarker"></div></div>
    </div>

    <div id="locationBar">―― 場所名 ――</div>

    <main id="logContainer"></main>

    <div id="specialActionContainer">
        <button id="btnDeliver" class="special-btn" onclick="gameAction.deliver()">[ 銀貨を3枚納品する ]</button>
    </div>

    <footer>
        <button id="btnMoveForward" class="btn" onclick="gameAction.move(1)">進む</button>
        <button id="btnMoveBack" class="btn" onclick="gameAction.move(-1)">戻る</button>
        <button id="btnTalk" class="btn" onclick="gameAction.talk()">話す</button>
        <button id="btnItem" class="btn" onclick="gameAction.useItem()">アイテム</button>
    </footer>

    <div id="itemModal">
        <div class="modal-content">
            <div style="padding:15px; border-bottom:1px solid #333; text-align:center; font-weight:bold;">所持品</div>
            <div id="itemList" class="item-list-container"></div>
            <div id="itemDetailArea" class="item-detail-area">アイテムを選択してください</div>
            <button class="btn" style="margin:10px;" onclick="uiControl.closeModal()">閉じる</button>
        </div>
    </div>

    <script>
        // --- 定数・設定管理 ---
        const CONFIG = {
            MAX_DISTANCE: 10,
            MIN_DISTANCE: 0,
            ITEM_NAME: { silverCoin: "銀貨", herb: "薬草" },
            ITEM_DESC: { 
                silverCoin: "宿屋に納品するための銀貨。3枚必要だ。", 
                herb: "傷を癒やす野草。HPを全回復する。" 
            }
        };

        const LOCATIONS = {
            0: { name: "宿屋前", hasTarget: true, desc: "出発の準備は整った。" },
            1: { name: "琥珀の森", hasTarget: false, desc: "鳥の鳴き声が聞こえる…" },
            7: { name: "森の深層", hasTarget: true, desc: "空気が湿ってきた…" }
        };

        // --- 状態管理 ---
        let gameState = {
            currentDistance: 0,
            cainLv: 1,
            cainHP: 100,
            cainMaxHP: 100,
            inventory: { silverCoin: 0, herb: 1 },
            flags: { isDelivered: false, gotTestCoin: false }
        };

        // --- UI操作モジュール ---
        const uiControl = {
            addLog: function(text, type = "") {
                const container = document.getElementById('logContainer');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                if (type === "marker") entry.classList.add('log-marker');
                entry.textContent = text;
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
            },

            updateUI: function() {
                const loc = this.getLocData(gameState.currentDistance);
                
                // ステータス・プログレス
                document.getElementById('statusInfo').textContent = `カイン Lv.${gameState.cainLv} [ ${gameState.cainHP} / ${gameState.cainMaxHP} ]`;
                document.getElementById('hpFill').style.width = `${(gameState.cainHP / gameState.cainMaxHP) * 100}%`;
                document.getElementById('locationBar').textContent = `―― ${loc.name} ――`;
                const ratio = (gameState.currentDistance / CONFIG.MAX_DISTANCE) * 100;
                document.getElementById('progressMarker').style.left = `${ratio}%`;
                document.getElementById('progressText').textContent = `( ${gameState.currentDistance} / ${CONFIG.MAX_DISTANCE}m )`;

                // 納品ボタンの制御 (位置変更後もロジックは維持)
                const specialArea = document.getElementById('specialActionContainer');
                const showDeliver = (gameState.currentDistance === 0 && gameState.inventory.silverCoin >= 3 && !gameState.flags.isDelivered);
                specialArea.style.display = showDeliver ? 'block' : 'none';
                if (showDeliver) document.getElementById('btnDeliver').disabled = false;

                // フッターボタン制御
                document.getElementById('btnMoveForward').disabled = (gameState.currentDistance >= CONFIG.MAX_DISTANCE);
                document.getElementById('btnMoveBack').disabled = (gameState.currentDistance <= CONFIG.MIN_DISTANCE);
                document.getElementById('btnTalk').disabled = !loc.hasTarget;
            },

            getLocData: function(dist) {
                const keys = Object.keys(LOCATIONS).map(Number).sort((a, b) => b - a);
                return LOCATIONS[keys.find(k => dist >= k)];
            },

            openModal: function() {
                const modal = document.getElementById('itemModal');
                const list = document.getElementById('itemList');
                const detail = document.getElementById('itemDetailArea');
                list.innerHTML = '';
                detail.textContent = 'アイテムを選択してください';
                
                const items = Object.entries(gameState.inventory).filter(([k,v]) => v > 0);
                if (items.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:20px;">所持品なし</div>';
                } else {
                    items.forEach(([key, count]) => {
                        const div = document.createElement('div');
                        div.className = 'item-row';
                        div.textContent = `${CONFIG.ITEM_NAME[key]} (×${count})`;
                        div.onclick = () => this.selectItem(key, count);
                        list.appendChild(div);
                    });
                }
                modal.style.display = 'flex';
            },

            selectItem: function(key, count) {
                const detail = document.getElementById('itemDetailArea');
                let html = `<strong>${CONFIG.ITEM_NAME[key]}</strong> (×${count})<br><span style="font-size:12px;color:#aaa;">${CONFIG.ITEM_DESC[key]}</span>`;
                if (key === 'herb') {
                    html += `<br><button class="btn" style="height:35px;margin:10px auto 0;width:120px;" onclick="gameAction.executeHerb()">使う</button>`;
                }
                detail.innerHTML = html;
            },

            closeModal: function() { document.getElementById('itemModal').style.display = 'none'; }
        };

        // --- ゲーム論理モジュール ---
        const gameAction = {
            move: function(step) {
                const prevLoc = uiControl.getLocData(gameState.currentDistance).name;
                let nextDist = gameState.currentDistance + step;

                if (!gameState.flags.isDelivered && nextDist >= CONFIG.MAX_DISTANCE) {
                    nextDist = CONFIG.MAX_DISTANCE;
                    if (gameState.currentDistance === CONFIG.MAX_DISTANCE && step > 0) {
                        uiControl.addLog("門番『通行証か納品が済むまでは通せん。』");
                        return;
                    }
                }

                if (nextDist < CONFIG.MIN_DISTANCE || nextDist > CONFIG.MAX_DISTANCE) return;

                gameState.currentDistance = nextDist;
                uiControl.updateUI();
                uiControl.addLog(`${gameState.currentDistance}m地点へ移動した。`);

                if (gameState.currentDistance === 3 && !gameState.flags.gotTestCoin) {
                    gameState.flags.gotTestCoin = true;
                    gameState.inventory.silverCoin += 3;
                    uiControl.addLog("道端に銀貨が3枚落ちている！カインはそれを拾い上げた。");
                }

                const nextLoc = uiControl.getLocData(gameState.currentDistance);
                if (prevLoc !== nextLoc.name) {
                    setTimeout(() => {
                        uiControl.addLog(`―― ${nextLoc.name} ――`, "marker");
                        uiControl.addLog(nextLoc.desc);
                    }, 800);
                }
            },

            talk: function() {
                const dist = gameState.currentDistance;
                if (dist === 0) {
                    uiControl.addLog(gameState.flags.isDelivered ? "宿屋の主人『気をつけてな！』" : "宿屋の主人『銀貨を3枚、頼んだぞ。』");
                } else if (dist >= 7) {
                    uiControl.addLog("（周囲を警戒している…）");
                }
            },

            deliver: function() {
                const btn = document.getElementById('btnDeliver');
                btn.disabled = true;
                gameState.inventory.silverCoin -= 3;
                gameState.flags.isDelivered = true;
                uiControl.addLog("銀貨を納品した。");
                uiControl.addLog("宿屋の主人『助かった！これで荷馬車の準備ができる。』");
                uiControl.updateUI();
            },

            useItem: function() { uiControl.openModal(); },

            executeHerb: function() {
                if (gameState.inventory.herb > 0) {
                    gameState.inventory.herb--;
                    gameState.cainHP = gameState.cainMaxHP;
                    uiControl.updateUI();
                    uiControl.closeModal();
                    uiControl.addLog("薬草を使い、HPが全回復した。");
                }
            }
        };

        window.onload = () => { uiControl.addLog("探索を開始した。"); uiControl.updateUI(); };
    </script>
</body>
</html>
