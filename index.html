<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resonance RPG -Standard Fix-</title>
    <style>
        :root { --bg: #0a0a0c; --owen: #a335ee; --cain: #f1c40f; --hp: #e74c3c; --panel: #1a1a20; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { background: var(--bg); color: #dcdde1; font-family: sans-serif; display: flex; flex-direction: column; height: 100dvh; width: 100vw; overflow: hidden; padding: 10px; }
        
        /* UIパーツ */
        .m-hdr { flex-shrink: 0; background: #000; border: 1px solid var(--cain); padding: 8px; border-radius: 4px; margin-bottom: 8px; text-align: center; }
        .st-bar { flex-shrink: 0; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #111; padding: 6px; border-radius: 4px; border: 1px solid #333; }
        .c-lbl { font-size: 11px; font-weight: bold; color: var(--cain); white-space: nowrap; }
        .bar-wrap { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .bg-b { background: #222; height: 6px; border-radius: 3px; overflow: hidden; }
        #h-fill { background: var(--hp); height: 100%; transition: width 0.3s; }
        #m-fill { background: #3498db; height: 100%; transition: width 0.3s; }
        
        .d-ui { flex-shrink: 0; font-size: 11px; text-align: center; margin-bottom: 8px; color: #aaa; }
        #log { flex-grow: 1; overflow-y: auto; background: #000; border: 1px solid #222; border-radius: 4px; padding: 12px; font-size: 13px; line-height: 1.6; margin-bottom: 10px; }
        
        .log-owen { color: var(--owen); font-weight: bold; }
        .log-dmg { color: #ff7675; } 
        .log-sys { color: #888; font-size: 11px; margin-top: 4px; border-top: 1px solid #111; padding-top: 2px; }
        .log-atk { color: #f1c40f; }

        .btns { flex-shrink: 0; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        button { background: #252e38; color: #fff; border: 1px solid #444; padding: 10px 4px; border-radius: 6px; font-size: 12px; font-weight: bold; min-height: 54px; cursor: pointer; }
        button:active { background: #1a252f; border-color: var(--cain); }

        #btn-boss, #btn-inn { grid-column: span 3; display: none; margin-bottom: 8px; }
        #btn-boss { background: #633277; border: 1px solid var(--owen); }
        #btn-inn { background: #2c3e50; border-color: var(--cain); }

        /* モーダル */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: var(--panel); border: 1px solid #444; width: 90%; padding: 20px; border-radius: 8px; }
        .m-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; border-bottom: 1px solid #333; padding-bottom: 4px; }
    </style>
</head>
<body>

    <div class="m-hdr" id="m-box">
        <div style="font-weight:bold; color:var(--cain); font-size:14px;">目的：古い銀貨を3枚持ち帰れ</div>
        <div style="font-size:11px;" id="m-count">倉庫の蓄え: 0 / 3</div>
    </div>

    <div class="st-bar">
        <span class="c-lbl" id="c-lv">Lv.1 CAIN</span>
        <div class="bar-wrap">
            <div class="bg-b"><div id="h-fill" style="width: 100%;"></div></div>
            <div class="bg-b"><div id="m-fill" style="width: 100%;"></div></div>
        </div>
    </div>

    <div class="d-ui" id="dist-ui">宿屋まで: 0km / 目的地まで: 10km</div>

    <div id="log"></div>

    <button id="btn-boss" onclick="act('boss')">深部に潜む影と対峙する</button>
    <button id="btn-inn" onclick="act('inn')">宿屋の暖簾を潜る</button>

    <div class="btns">
        <button id="btn-fwd" onclick="act('move', 'fwd')">進む</button>
        <button id="btn-bwd" onclick="act('move', 'bwd')">戻る</button>
        <button id="btn-item" onclick="toggleModal(true)">アイテム/強化</button>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3 style="color:var(--cain); margin-bottom:15px; border-bottom:1px solid var(--cain);">探索状況・所持品</h3>
            <div class="m-row"><span>カインの能力 (ATK/DEF)</span><span><span id="mdl-atk">10</span> / <span id="mdl-def">5</span></span></div>
            <div class="m-row"><span>手荷物の銀貨 (未精算)</span><span id="mdl-t">0</span></div>
            <div class="m-row"><span>倉庫の銀貨 (精算済)</span><span id="mdl-g">0</span></div>
            <div class="m-row"><span>薬草</span><span id="mdl-hb">0</span></div>
            <div class="m-row"><span>甘味</span><span id="mdl-sw">3</span></div>
            
            <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-top:15px;">
                <button onclick="act('use_hb')" style="background:#2d5a27; min-height:40px;">薬草を使う (HP+30)</button>
                <button id="shop-atk" onclick="act('shop_atk')" style="background:#4a3c28; min-height:40px; display:none;">武器を研ぐ (倉庫の銀貨3消費: ATK+2)</button>
                <button onclick="toggleModal(false)" style="background:#333; min-height:40px;">閉じる</button>
            </div>
        </div>
    </div>

<script>
window.onload = function() {
    let st = { 
        lv: 1, exp: 0, atk: 10, def: 5,
        c_h: 120, c_mh: 120, c_m: 50, c_mm: 50, 
        gInv: 0, tInv: 0, herb: 0, sw: 3, 
        dist: 10, kainKills: 0, owenKills: 0, inCombat: false
    };

    const log = document.getElementById('log');
    const add = (txt, cls="") => {
        const d = document.createElement('div'); if(cls) d.className = cls;
        d.innerHTML = txt; log.appendChild(d); log.scrollTop = log.scrollHeight;
    };

    // モーダル表示切替
    window.toggleModal = (show) => {
        const m = document.getElementById('modal');
        if(show) {
            document.getElementById('mdl-atk').innerText = st.atk;
            document.getElementById('mdl-def').innerText = st.def;
            document.getElementById('mdl-t').innerText = st.tInv;
            document.getElementById('mdl-g').innerText = st.gInv;
            document.getElementById('mdl-hb').innerText = st.herb;
            document.getElementById('mdl-sw').innerText = st.sw;
            // 宿屋(距離10)にいる時だけ強化ボタンを出す
            document.getElementById('shop-atk').style.display = (st.dist >= 10) ? "block" : "none";
            m.style.display = 'flex';
        } else {
            m.style.display = 'none';
        }
    };

    function ui() {
        document.getElementById('h-fill').style.width = (st.c_h / st.c_mh * 100) + "%";
        document.getElementById('m-fill').style.width = (st.c_m / st.c_mm * 100) + "%";
        document.getElementById('c-lv').innerText = `Lv.${st.lv} CAIN`;
        document.getElementById('m-count').innerText = `倉庫の蓄え: ${st.gInv} / 3`;
        document.getElementById('dist-ui').innerText = `宿屋まで: ${10-st.dist}km / 目的地まで: ${st.dist}km`;
        
        // 戦闘中でなければボタンを表示
        const idle = !st.inCombat;
        document.getElementById('btn-boss').style.display = (idle && st.dist <= 0) ? "block" : "none";
        document.getElementById('btn-inn').style.display = (idle && st.dist >= 10) ? "block" : "none";
        document.getElementById('btn-fwd').style.display = (idle && st.dist > 0) ? "block" : "none";
        document.getElementById('btn-bwd').style.display = (idle && st.dist < 10) ? "block" : "none";
        document.getElementById('btn-item').disabled = st.inCombat;
    }

    async function battle(isBoss = false) {
        st.inCombat = true; ui();
        let e_hp = isBoss ? 200 : 30 + (st.lv * 10);
        add(isBoss ? "【深部の闇】が巨大な『厄災の残滓』として現れた。" : "魔物が前方を阻んだ。", "log-sys");

        while(e_hp > 0 && st.c_h > 0) {
            await new Promise(r => setTimeout(r, 600));
            let neglect = false;

            // オーエン判定
            const o_roll = Math.random();
            if(o_roll < 0.1) {
                st.owenKills++;
                add("<span class='log-owen'>【助力を得る】</span>「……目障りだ」 オーエンが指先で虚空をなぞると、魔物は内側から弾け飛んだ。", "log-owen");
                e_hp = 0; break;
            } else if(o_roll < 0.25) {
                add("<span class='log-owen'>【冷淡な観測】</span>オーエンは退屈そうに爪を眺め、戦況を黙殺している。", "log-owen");
                neglect = true;
            }

            // カイン攻撃
            const dmg = Math.max(1, st.atk + Math.floor(Math.random()*5));
            e_hp -= dmg;
            add(`カインの剣撃：魔物に ${dmg} の損傷を与えた。`, "log-atk");
            if(e_hp <= 0) break;

            // 反撃
            let e_dmg = Math.max(1, (isBoss ? 25 : 12) - st.def);
            if(neglect) e_dmg = Math.floor(e_dmg * 1.5);
            st.c_h -= e_dmg;
            add(`魔物の反撃：カインは ${e_dmg} の衝撃を受けた。`, "log-dmg");
        }

        if(st.c_h <= 0) {
            add("【敗走】意識が途切れた。手荷物を失い、宿屋へ運び込まれた。", "log-dmg");
            st.dist = 10; st.tInv = 0; st.c_h = 20;
        } else if(e_hp <= 0) {
            st.kainKills++;
            add(isBoss ? "第1章クリア。宿屋で一休みしよう。" : "魔物を討ち果たした。");
            st.exp += (isBoss ? 100 : 20);
            if(st.exp >= st.lv * 50) {
                st.lv++; st.exp = 0; st.atk += 2; st.def += 1;
                st.c_h = st.c_mh; add(`【LvUP】カインの練度が向上した。 (Lv.${st.lv})`, "log-sys");
            }
            // ドロップ
            if(Math.random() < 0.6) {
                const r = Math.random();
                if(r < 0.5) { st.tInv++; add("[古い銀貨]を回収。", "log-sys"); }
                else if(r < 0.8) { st.herb++; add("[薬草]を回収。", "log-sys"); }
                else { st.sw++; add("[甘味]を回収。", "log-sys"); }
            }
        }
        st.inCombat = false;
        if(isBoss && st.c_h > 0) st.dist = 10; // ボス撃破後は宿屋門前へ
        ui();
    }

    window.act = function(type, arg) {
        if(type === 'move') {
            const move = Math.random() > 0.5 ? 2 : 1;
            if(arg === 'fwd') st.dist = Math.max(0, st.dist - move);
            else st.dist = Math.min(10, st.dist + move);
            add(arg === 'fwd' ? `${move}km、深部へと進む。` : `${move}km、宿屋へ戻る道を行く。`);
            if(Math.random() < 0.45) battle();
            else ui();
        } else if(type === 'boss') {
            battle(true);
        } else if(type === 'use_hb') {
            if(st.herb > 0) {
                st.herb--; st.c_h = Math.min(st.c_mh, st.c_h + 30);
                add("薬草を煎じ、傷を塞いだ。 (HP+30)");
                toggleModal(false); ui();
            }
        } else if(type === 'shop_atk') {
            if(st.gInv >= 3) {
                st.gInv -= 3; st.atk += 2;
                add("【強化】カインの剣が鋭く研ぎ澄まされた。 (ATK+2)", "log-sys");
                toggleModal(false); ui();
            }
        } else if(type === 'inn') {
            if(st.tInv > 0) add(`【精算】手荷物の銀貨 ${st.tInv}枚 を倉庫に納めた。`, "log-sys");
            st.gInv += st.tInv; st.tInv = 0; 
            st.c_h = st.c_mh; st.c_m = st.c_mm;
            add("【宿屋】カインは休息をとり、オーエンは退屈そうに椅子に座った。");
            ui();
        }
    };
    ui();
};
</script>
</body>
</html>
