<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resonance RPG -Layout Fix-</title>
    <style>
        :root { --bg: #0a0a0c; --panel: #1a1a20; --owen: #9b59b6; --cain: #f1c40f; --hp: #e74c3c; --text: #dcdde1; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg); color: var(--text); font-family: sans-serif; 
            display: flex; flex-direction: column; 
            height: 100vh; width: 100vw; overflow: hidden;
            padding: 8px;
        }
        
        /* 1. ミッション（最上部：高さを固定） */
        .m-hdr { 
            flex-shrink: 0;
            background: #000; border: 1px solid var(--cain); padding: 6px; 
            border-radius: 4px; margin-bottom: 6px; text-align: center; 
        }
        #m-idx { font-size: 13px; font-weight: bold; color: var(--cain); }
        .m-st { font-size: 11px; color: #fff; }
        .achieved { background: var(--cain) !important; color: #000 !important; }

        /* 2. カインのステータス（高さを固定） */
        .stat-line { 
            flex-shrink: 0;
            background: #111; padding: 6px 10px; border-radius: 4px; margin-bottom: 6px;
            display: flex; align-items: center; border: 1px solid #333;
        }
        .c-lbl { font-size: 11px; font-weight: bold; color: var(--cain); width: 40px; }
        .bar-wrap { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
        .bar-inner { display: flex; align-items: center; gap: 8px; }
        .bg-b { background: #222; height: 6px; flex-grow: 1; border-radius: 3px; overflow: hidden; }
        #h-fill { background: var(--hp); height: 100%; transition: width 0.3s; }
        #m-fill { background: #3498db; height: 100%; transition: width 0.3s; }
        .num-t { font-size: 10px; font-family: monospace; min-width: 45px; text-align: right; }

        /* 3. 情報：一行（高さを固定） */
        .i-bar { 
            flex-shrink: 0;
            font-size: 10px; background: #000; padding: 4px; display: flex; 
            justify-content: space-around; margin-bottom: 6px; border-radius: 4px;
        }
        
        /* 4. 操作ボタン（最下部：ここを優先的に表示させる） */
        .btns { 
            flex-shrink: 0; /* ボタンの高さが削られないように固定 */
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px; 
            padding-bottom: env(safe-area-inset-bottom); /* iPhoneのバー対策 */
            margin-top: auto; /* ログの下に配置 */
        }
        button { 
            background: #252e38; color: #fff; border: 1px solid #444; padding: 8px 4px; 
            border-radius: 6px; font-size: 12px; font-weight: bold; min-height: 54px; cursor: pointer; 
        }
        button:active { background: #000; border-color: var(--cain); }
        #btn-boss { background: #633277; grid-column: span 2; display: none; border-color: var(--owen); margin-bottom: 4px; }
        .sub { font-size: 9px; opacity: 0.7; display: block; font-weight: normal; margin-top: 2px; }

        /* 5. ログ（余ったスペースをすべて使う。ここがスクロールする） */
        #log { 
            flex-grow: 1; 
            overflow-y: auto; 
            background: #000; border: 1px solid #222; border-radius: 4px;
            padding: 10px; font-size: 13px; line-height: 1.6;
            margin-bottom: 8px; /* ボタンとの隙間 */
        }
        .log-owen { color: var(--owen); font-weight: bold; }
        .log-dmg { color: #ff7675; } 
        .log-sys { color: #888; font-size: 11px; margin-bottom: 6px; border-bottom: 1px solid #1a1a1a; padding-bottom: 2px; }
    </style>
</head>
<body>

    <div class="m-hdr" id="m-box">
        <span id="m-idx">目的：古い銀貨を3枚持ち帰れ</span>
        <div class="m-st" id="m-det">進行状況: 0 / 3 (未達成)</div>
    </div>

    <div class="stat-line">
        <span class="c-lbl">CAIN</span>
        <div class="bar-wrap">
            <div class="bar-inner">
                <div class="bg-b"><div id="h-fill" style="width: 100%;"></div></div>
                <span class="num-t">HP <span id="hp-v">120</span></span>
            </div>
            <div class="bar-inner">
                <div class="bg-b"><div id="m-fill" style="width: 100%;"></div></div>
                <span class="num-t">MP <span id="mp-v">50</span></span>
            </div>
        </div>
    </div>

    <div class="i-bar">
        <span>倉庫:<b id="g-inv">0</b></span>
        <span>手荷物:<b id="t-inv">0</b></span>
        <span>甘味:<b id="sw">3</b></span>
        <span>残り:<b id="dist">10</b>km</span>
    </div>

    <div id="log"></div>

    <div class="btns">
        <button id="btn-boss" onclick="act('boss')">深部に潜む影を、塵に還す</button>
        <button onclick="act('safe')">慎重に進む<span class="sub">1km / リスク低</span></button>
        <button onclick="act('bold')">大胆に進む<span class="sub">2km / リスク高</span></button>
        <button onclick="act('eat')">甘味消費<span class="sub">オーエンを宥める</span></button>
        <button onclick="act('inn')">宿屋に戻る<span class="sub">精算・全回復</span></button>
    </div>

<script>
window.onload = function() {
    const MISSIONS = [{ target: 'coin', count: 3, label: '古い銀貨' }];
    let st = { o_m: 120, o_mm: 120, c_h: 120, c_mh: 120, c_m: 50, c_mm: 50, gInv: {coin:0}, tInv: [], sw: 3, mIdx: 0, dist: 10 };

    function ui() {
        document.getElementById('h-fill').style.width = (st.c_h / st.c_mh * 100) + "%";
        document.getElementById('m-fill').style.width = (st.c_m / st.c_mm * 100) + "%";
        document.getElementById('hp-v').innerText = st.c_h;
        document.getElementById('mp-v').innerText = st.c_m;
        document.getElementById('dist').innerText = st.dist;
        document.getElementById('btn-boss').style.display = (st.dist === 0) ? "block" : "none";

        const m = MISSIONS[st.mIdx] || {label:"完了", target:"", count:0};
        const total = (st.gInv[m.target] || 0) + st.tInv.filter(id => id === m.target).length;
        const ready = (m.target !== "" && total >= m.count);
        
        document.getElementById('m-idx').innerText = m.target ? `目的：${m.label}を${m.count}枚持ち帰れ` : "全依頼完了";
        document.getElementById('m-det').innerText = `進行状況: ${total} / ${m.count} (${ready ? '達成：宿屋へ戻れ' : '未達成'})`;
        document.getElementById('m-box').className = ready ? "m-hdr achieved" : "m-hdr";

        document.getElementById('sw').innerText = st.sw;
        document.getElementById('t-inv').innerText = st.tInv.length;
        document.getElementById('g-inv').innerText = st.gInv.coin;
    }

    window.act = function(type) {
        if(st.c_h <= 0 && type !== 'inn') return;
        const log = document.getElementById('log');
        const add = (txt, cls="") => {
            const d = document.createElement('div'); if(cls) d.className = cls;
            d.innerHTML = txt; log.appendChild(d); log.scrollTop = log.scrollHeight;
        };

        if(type === 'safe' || type === 'bold') {
            const isB = type === 'bold';
            st.dist = Math.max(0, st.dist - (isB ? 2 : 1));
            st.o_m -= (isB ? 20 : 8);
            add(isB ? "オーエンが最短距離を突き進んだ。" : "カインが周囲を警戒し道を作った。");
            if(Math.random() < 0.25) add("<span class='log-owen'>【オーエン】</span>「……邪魔だ」 紫の閃光が辺りを白く染める。", "log-owen");
            if(Math.random() < (isB ? 0.6 : 0.25)) {
                st.c_h -= isB ? 25 : 12;
                add("敵の強襲。カインが盾となり衝撃を殺した。", "log-dmg");
                if(st.c_h <= 0) {
                    add("【全滅】カインが倒れ、全てを失って這い戻った。", "log-dmg");
                    st.tInv = []; st.dist = 10; st.c_h = 10;
                } else {
                    st.tInv.push('coin'); add("[古い銀貨]を回収。", "log-sys");
                }
            }
        } else if(type === 'boss') {
            add("<span class='log-owen'>【オーエン】</span>「塵に還れ」 凄まじい衝撃とともに影が霧散した。", "log-owen");
            add("目的地クリア。宿屋で一休みしよう。", "log-ev");
            st.dist = 10;
        } else if(type === 'eat') {
            if(st.sw > 0) { st.sw--; st.o_m = st.o_mm; add("オーエンは菓子を咀嚼し、わずかに機嫌を直した。"); }
        } else if(type === 'inn') {
            st.tInv.forEach(id => { st.gInv[id] = (st.gInv[id]||0)+1; });
            st.tInv = []; st.c_h=st.c_mh; st.c_m=st.c_mm; st.o_m=st.o_mm; st.sw=3; st.dist=10;
            const m = MISSIONS[st.mIdx];
            if(m && (st.gInv[m.target]||0) >= m.count) {
                add("【完了】主人が銀貨を受け取り、報酬を渡してくれた。", "log-ev");
                st.mIdx++;
            } else { add("宿屋に帰還。カインは黙々と装備を磨いた。"); }
        }
        ui();
    };
    ui();
    add("宿屋の主人：『悪いが、古い銀貨を3枚集めてきてくれ』", "log-sys");
};
</script>
</body>
</html>