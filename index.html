<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>因縁の旅路 - Fragment of Fate</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-bg: #1a1a1a;
            --text-main: #e0e0e0;
            --accent-gold: #ffcc00;
            --accent-purple: #a335ee;
            --accent-red: #ff4d4d;
            --accent-blue: #3399ff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Hiragino Mincho ProN', 'serif';
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* 目的・ステータス表示 */
        #header-ui { margin-bottom: 8px; }
        #mission-panel {
            border: 2px solid var(--accent-gold);
            padding: 6px;
            text-align: center;
            background: rgba(255, 204, 0, 0.1);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .status-row {
            display: flex;
            align-items: center;
            background: var(--panel-bg);
            padding: 8px;
            border-left: 4px solid var(--accent-gold);
            margin-bottom: 4px;
        }
        .bar-container { flex-grow: 1; margin-left: 10px; }
        .bar-bg { background: #333; height: 6px; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        #hp-fill { background: var(--accent-red); }
        #mp-fill { background: var(--accent-blue); }
        .label { font-size: 0.8em; min-width: 40px; }

        /* アイテムスロットUI */
        #inventory-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }
        .slot {
            background: #222;
            border: 1px solid #444;
            padding: 4px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            border-radius: 4px;
        }
        .slot-name { margin-bottom: 4px; color: #aaa; text-align: center; line-height: 1.1; }
        .use-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 0.9em;
        }

        /* 資産・距離表示 */
        #sub-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            background: #111;
            padding: 5px 10px;
            margin-bottom: 8px;
            border: 1px solid #333;
        }

        /* ログエリア */
        #log {
            flex-grow: 1;
            background: #050505;
            border: 1px solid #333;
            padding: 10px;
            font-size: 0.85em;
            line-height: 1.6;
            overflow-y: auto;
            margin-bottom: 8px;
        }
        .msg { margin-bottom: 6px; }
        .purple { color: var(--accent-purple); font-weight: bold; }
        .red { color: var(--accent-red); }
        .gold { color: var(--accent-gold); }
        .system { color: #888; font-style: italic; }

        /* 操作パネル */
        #controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding-bottom: 10px;
        }
        button.main-action {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 15px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        button:active { filter: brightness(1.3); }
    </style>
</head>
<body>

    <div id="header-ui">
        <div id="mission-panel">
            <span id="mission-text">古い銀貨を3枚持ち帰れ</span><br>
            <small id="mission-status">進行状況: 0 / 3 (未達成)</small>
        </div>

        <div class="status-row">
            <div class="label">CAIN</div>
            <div class="bar-container">
                <div class="bar-bg"><div id="hp-fill" class="bar-fill" style="width: 100%;"></div></div>
                <div class="bar-bg" style="margin-top:4px;"><div id="mp-fill" class="bar-fill" style="width: 100%;"></div></div>
            </div>
            <div style="font-size: 0.7em; margin-left: 8px; text-align: right;">
                HP <span id="hp-val">120</span><br>MP <span id="mp-val">50</span>
            </div>
        </div>
    </div>

    <div id="inventory-row">
        <div class="slot" id="slot-0"></div>
        <div class="slot" id="slot-1"></div>
        <div class="slot" id="slot-2"></div>
    </div>

    <div id="sub-info">
        <span>宿屋まで: <span id="dist-home">0</span>km</span>
        <span>目的地まで: <span id="dist-target">10</span>km</span>
        <span>倉庫: <span id="storage-count">0</span></span>
    </div>

    <div id="log"></div>

    <div id="controls">
        <button class="main-action" onclick="game.action(1)">目的地へ進む<br><small>1-2km進行 / 遭遇あり</small></button>
        <button class="main-action" style="background:#34495e;" onclick="game.action(-1)">引き返す（宿屋へ）<br><small>1-2km後退 / 遭遇あり</small></button>
    </div>

    <script>
        const game = {
            hp: 120, maxHp: 120,
            mp: 50, maxMp: 50,
            dist: 10, // 10が宿屋、0が最深部
            storage: 0,
            inventory: [], // 最大3つのアイテム
            kainKills: 0,
            owenKills: 0,
            owenMood: 50,
            missionTarget: 3,

            init() {
                this.addLog("宿屋の主人：『銀貨を3枚だ。生きて帰れたら受け取ってやる』", "system");
                this.updateUI();
            },

            addLog(text, type = "") {
                const log = document.getElementById('log');
                const div = document.createElement('div');
                div.className = 'msg ' + type;
                div.innerHTML = text;
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            },

            updateUI() {
                document.getElementById('hp-fill').style.width = (this.hp / this.maxHp * 100) + '%';
                document.getElementById('mp-fill').style.width = (this.mp / this.maxMp * 100) + '%';
                document.getElementById('hp-val').innerText = Math.ceil(this.hp);
                document.getElementById('mp-val').innerText = this.mp;
                
                document.getElementById('dist-home').innerText = 10 - this.dist;
                document.getElementById('dist-target').innerText = this.dist;
                document.getElementById('storage-count').innerText = this.storage;

                const statusText = this.storage >= this.missionTarget ? 
                    `<span class="gold">達成：報告せよ</span>` : 
                    `進行状況: ${this.storage} / ${this.missionTarget} (未達成)`;
                document.getElementById('mission-status').innerHTML = statusText;

                // スロットの更新
                for (let i = 0; i < 3; i++) {
                    const slot = document.getElementById(`slot-${i}`);
                    const item = this.inventory[i];
                    if (item) {
                        const canUse = item === "薬草" || item === "甘味";
                        slot.innerHTML = `
                            <div class="slot-name">${item}</div>
                            ${canUse ? `<button class="use-btn" onclick="game.useItem(${i})">使う</button>` : `<small style="color:#555">使用不可</small>`}
                        `;
                    } else {
                        slot.innerHTML = `<div class="slot-name" style="color:#333">(空)</div>`;
                    }
                }
            },

            action(dir) {
                const step = Math.floor(Math.random() * 2) + 1;
                if (dir > 0) {
                    this.dist = Math.max(0, this.dist - step);
                    this.addLog(`${step}km、深部へ歩を進めた。`);
                } else {
                    this.dist = Math.min(10, this.dist + step);
                    this.addLog(`${step}km、宿屋への道を引き返した。`);
                }

                // 戦闘判定
                if (Math.random() < 0.4) {
                    this.battle();
                }

                if (this.dist === 10 && dir < 0) this.goHome();
                if (this.hp <= 0) this.die();
                this.updateUI();
            },

            battle() {
                if (Math.random() < 0.5) {
                    this.kainKills++;
                    this.addLog("カインの剣が魔物の急所を正確に貫いた。");
                } else {
                    this.owenKills++;
                    this.addLog("【オーエン】指先から放たれた紫の閃光が魔物を塵に変えた。", "purple");
                }

                // 被ダメ
                const dmg = Math.floor(Math.random() * 15) + 5;
                this.hp -= dmg;
                this.addLog("背後からの強襲。カインが盾となり衝撃を殺した。", "red");

                // アイテムドロップ
                if (Math.random() < 0.6) {
                    const items = ["薬草", "古い銀貨", "甘味"];
                    const found = items[Math.floor(Math.random() * items.length)];
                    this.pickItem(found);
                }
            },

            pickItem(itemName) {
                if (this.inventory.length < 3) {
                    this.inventory.push(itemName);
                    this.addLog(`[${itemName}] を回収。カバンに収めた。`, "gold");
                } else {
                    this.addLog(`荷物が一杯で [${itemName}] を諦めた。`, "system");
                }
            },

            useItem(index) {
                const item = this.inventory[index];
                if (item === "薬草") {
                    this.hp = Math.min(this.maxHp, this.hp + 25);
                    this.addLog("薬草を噛み砕き、傷口に塗った。痛みが僅かに引く。");
                } else if (item === "甘味") {
                    this.owenMood += 20;
                    this.addLog("【オーエン】カインの差し出した菓子を無言で受け取り、頬張った。", "purple");
                }
                this.inventory.splice(index, 1);
                this.updateUI();
            },

            goHome() {
                this.addLog("【拠点帰還】戦利品を精算。今回の総撃破数: " + (this.kainKills + this.owenKills) + ` (カイン:${this.kainKills} / オーエン:${this.owenKills})`, "gold");
                
                // インベントリから精算
                this.inventory.forEach(item => {
                    if (item === "古い銀貨") this.storage++;
                });
                this.inventory = [];
                
                this.hp = this.maxHp;
                this.kainKills = 0;
                this.owenKills = 0;
                this.addLog("宿屋の柔らかなベッドがカインの意識を奪った。", "system");
            },

            die() {
                this.addLog("カインの意識が途切れた。オーエンは冷めた目でそれを見下ろしたのち、彼を宿屋まで引きずっていった。", "red");
                this.inventory = [];
                this.hp = this.maxHp;
                this.dist = 10;
                this.kainKills = 0;
                this.owenKills = 0;
                this.updateUI();
            }
        };

        game.init();
    </script>
</body>
</html>