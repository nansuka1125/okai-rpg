<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resonance RPG -Recurrent System-</title>
    <style>
        :root { --bg: #0a0a0c; --owen: #a335ee; --cain: #f1c40f; --hp: #e74c3c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg); color: #dcdde1; font-family: sans-serif; 
            display: flex; flex-direction: column; 
            height: 100dvh; width: 100vw; overflow: hidden;
            padding: 8px;
        }
        
        /* 1. ミッション表示 */
        .m-hdr { flex-shrink: 0; background: #000; border: 1px solid var(--cain); padding: 5px; border-radius: 4px; margin-bottom: 6px; text-align: center; }
        .m-idx { font-size: 12px; font-weight: bold; color: var(--cain); display: block; }
        .achieved { background: var(--cain) !important; color: #000 !important; }

        /* 2. カイン・ステータス（1行圧縮） */
        .stat-line { 
            flex-shrink: 0; background: #111; padding: 6px 10px; border-radius: 4px; 
            margin-bottom: 6px; display: flex; align-items: center; border: 1px solid #333; gap: 10px;
        }
        .c-lbl { font-size: 11px; font-weight: bold; color: var(--cain); }
        .bar-wrap { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .bg-b { background: #222; height: 6px; border-radius: 3px; overflow: hidden; flex-grow: 1; margin-right: 5px; }
        #h-fill { background: var(--hp); height: 100%; transition: width 0.3s; }
        #m-fill { background: #3498db; height: 100%; transition: width 0.3s; }
        .num-t { font-size: 10px; font-family: monospace; color: #aaa; }

        /* 3. 距離・情報バー */
        .i-bar { 
            flex-shrink: 0; font-size: 10px; background: #1a1a1a; padding: 4px; 
            display: flex; justify-content: space-around; margin-bottom: 6px; border-radius: 4px; align-items: center;
        }
        .dist-info { font-weight: bold; color: #fff; background: #333; padding: 2px 8px; border-radius: 10px; }

        /* 4. ログ（スクロール） */
        #log { 
            flex-grow: 1; overflow-y: auto; background: #000; border: 1px solid #222; 
            border-radius: 4px; padding: 10px; font-size: 13px; line-height: 1.6; margin-bottom: 8px;
        }
        .log-owen { color: var(--owen); font-weight: bold; }
        .log-dmg { color: #ff7675; } 
        .log-sys { color: #888; font-size: 11px; margin-top: 4px; border-top: 1px solid #111; }

        /* 5. ボタン（固定） */
        .btns { flex-shrink: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        button { 
            background: #252e38; color: #fff; border: 1px solid #444; padding: 8px 4px; 
            border-radius: 6px; font-size: 11px; font-weight: bold; min-height: 50px; cursor: pointer; 
        }
        button:active { background: #1a252f; border-color: var(--cain); }
        button:disabled { opacity: 0.3; pointer-events: none; }
        #btn-boss { background: #633277; grid-column: span 2; display: none; margin-bottom: 4px; }
        .sub { font-size: 8px; opacity: 0.7; display: block; font-weight: normal; margin-top: 2px; }
    </style>
</head>
<body>

    <div class="m-hdr" id="m-box">
        <span class="m-idx">現在の目的：古い銀貨を3枚持ち帰れ</span>
        <div style="font-size:10px" id="m-count">進行状況: 0 / 3 (未達成)</div>
    </div>

    <div class="stat-line">
        <span class="c-lbl">CAIN</span>
        <div class="bar-wrap">
            <div style="display:flex; align-items:center">
                <div class="bg-b"><div id="h-fill" style="width: 100%;"></div></div>
                <span class="num-t">HP <span id="hp-v">120</span></span>
            </div>
            <div style="display:flex; align-items:center">
                <div class="bg-b"><div id="m-fill" style="width: 100%;"></div></div>
                <span class="num-t">MP <span id="mp-v">50</span></span>
            </div>
        </div>
    </div>

    <div class="i-bar">
        <span class="dist-info" id="dist-ui">宿屋まで: 0km / 目的地まで: 10km</span>
        <span>倉庫:<b id="g-inv">0</b></span>
        <span>手荷物:<b id="t-inv">0</b></span>
        <span>甘味:<b id="sw">3</b></span>
    </div>

    <div id="log"></div>

    <div class="btns">
        <button id="btn-boss" onclick="act('boss')">深部に潜む影と対峙する</button>
        <button id="btn-fwd" onclick="act('fwd')">目的地へ進む<span class="sub">1-2km進行 / 遭遇あり</span></button>
        <button id="btn-bwd" onclick="act('bwd')">引き返す（宿屋へ）<span class="sub">1-2km後退 / 遭遇あり</span></button>
        <button onclick="act('eat')">甘味消費<span class="sub">オーエンの機嫌を維持</span></button>
        <button id="btn-inn" onclick="act('inn')" style="border-color:var(--cain); display:none;">宿屋の暖簾を潜る<span class="sub">精算・全回復</span></button>
    </div>

<script>
window.onload = function() {
    let st = { 
        c_h: 120, c_mh: 120, c_m: 50, c_mm: 50, 
        gInv: 0, tInv: 0, sw: 3, 
        dist: 10, // 10=宿屋(スタート地点), 0=最深部
        kainKills: 0, owenKills: 0
    };

    function ui() {
        document.getElementById('h-fill').style.width = (st.c_h / st.c_mh * 100) + "%";
        document.getElementById('m-fill').style.width = (st.c_m / st.c_mm * 100) + "%";
        document.getElementById('hp-v').innerText = st.c_h;
        document.getElementById('mp-v').innerText = st.c_m;
        
        // UI調整：目的地と宿屋への距離を明示
        const toInn = 10 - st.dist;
        const toDest = st.dist;
        document.getElementById('dist-ui').innerText = `宿屋まで: ${toInn}km / 目的地まで: ${toDest}km`;

        // ボタン制御
        document.getElementById('btn-boss').style.display = (st.dist === 0) ? "block" : "none";
        document.getElementById('btn-fwd').disabled = (st.dist === 0);
        document.getElementById('btn-bwd').style.display = (st.dist === 10) ? "none" : "block";
        document.getElementById('btn-inn').style.display = (st.dist === 10) ? "block" : "none";

        const ready = (st.gInv >= 3);
        document.getElementById('m-count').innerText = `進行状況: ${st.gInv} / 3 (${ready ? '達成：報告せよ' : '未達成'})`;
        document.getElementById('m-box').className = ready ? "m-hdr achieved" : "m-hdr";
        document.getElementById('sw').innerText = st.sw;
        document.getElementById('t-inv').innerText = st.tInv;
        document.getElementById('g-inv').innerText = st.gInv;
    }

    window.act = function(type) {
        if(st.c_h <= 0 && type !== 'inn') return;
        const log = document.getElementById('log');
        const add = (txt, cls="") => {
            const d = document.createElement('div'); if(cls) d.className = cls;
            d.innerHTML = txt; log.appendChild(d); log.scrollTop = log.scrollHeight;
        };

        if(type === 'fwd' || type === 'bwd') {
            const move = Math.random() > 0.5 ? 2 : 1;
            if(type === 'fwd') st.dist = Math.max(0, st.dist - move);
            else st.dist = Math.min(10, st.dist + move);
            
            add(type === 'fwd' ? `${move}km、深部へ歩を進めた。` : `${move}km、宿屋への道を引き返した。`);

            // 遭遇・戦闘判定
            if(Math.random() < 0.4) {
                const isOwen = Math.random() > 0.5;
                if(isOwen) {
                    st.owenKills++;
                    add("<span class='log-owen'>【オーエン】</span>指先から放たれた紫の閃光が魔物を塵に変えた。", "log-owen");
                } else {
                    st.kainKills++;
                    add("カインの剣が魔物の急所を正確に貫いた。");
                }

                // ダメージ判定
                if(Math.random() < 0.5) {
                    const dmg = 15; st.c_h -= dmg;
                    add(`背後からの強襲。カインが盾となり衝撃を殺した。`, "log-dmg");
                    if(st.c_h <= 0) {
                        add("【敗走】カインが倒れ、全てを失い宿屋へ運び込まれた。", "log-dmg");
                        st.dist = 10; st.tInv = 0; st.c_h = 10;
                    } else {
                        st.tInv++; add("[古い銀貨]を回収。", "log-sys");
                    }
                }
            }
        } else if(type === 'boss') {
            st.owenKills++;
            add("<span class='log-owen'>【オーエン】</span>紫の炎が深部の闇を焼き払い、静寂が戻った。", "log-owen");
            st.dist = 2; // 便宜上、大幅に後退
        } else if(type === 'eat') {
            if(st.sw > 0) { st.sw--; add("オーエンは菓子を頬張り、退屈を紛らわせた。"); }
        } else if(type === 'inn') {
            st.gInv += st.tInv;
            const total = st.kainKills + st.owenKills;
            add(`【拠点帰還】戦利品を精算。今回の総撃破数: ${total} (カイン: ${st.kainKills} / オーエン: ${st.owenKills})`, "log-sys");
            st.tInv = 0; st.c_h=st.c_mh; st.sw=3;
            st.kainKills = 0; st.owenKills = 0; // カウントリセット
        }
        ui();
    };
    ui();
    add("宿屋の主人：『古い銀貨を3枚ほど集めてきてくれないか』", "log-sys");
};
</script>
</body>
</html>