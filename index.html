<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Resonance RPG -Rigid Loop-</title>
    <style>
        :root { --bg: #0a0a0c; --panel: #1a1a20; --owen: #9b59b6; --cain: #f1c40f; --hp: #e74c3c; --text: #dcdde1; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: serif; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .m-panel { border: 1px solid var(--cain); background: rgba(241, 196, 15, 0.05); padding: 8px; margin-bottom: 8px; border-radius: 4px; flex-shrink: 0; }
        .m-goal { font-size: 14px; font-weight: bold; display: flex; justify-content: space-between; }
        .dist-bar { text-align: center; font-size: 12px; color: #ff7675; margin-bottom: 4px; letter-spacing: 1px; }

        .s-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; flex-shrink: 0; }
        .card { background: var(--panel); padding: 10px; border-radius: 4px; border-left: 4px solid #444; }
        .stat { display: flex; justify-content: space-between; font-size: 12px; margin: 2px 0; }
        
        .inv-bar { font-size: 11px; background: #222; padding: 6px; display: flex; justify-content: space-around; margin-bottom: 8px; border-radius: 4px; flex-shrink: 0; }
        
        #log { background: #000; flex-grow: 1; overflow-y: auto; padding: 12px; font-size: 13px; line-height: 1.6; border: 1px solid #333; margin-bottom: 10px; border-radius: 4px; }
        .log-ev { color: #55efc4; } .log-dmg { color: #ff7675; font-weight: bold; } .log-sys { color: #888; font-size: 11px; }
        .log-ann { border-top: 1px double #444; border-bottom: 1px double #444; padding: 4px 0; margin: 5px 0; text-align: center; color: var(--cain); }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-shrink: 0; padding-bottom: 10px; }
        button { background: #2c3e50; color: #fff; border: 1px solid #444; padding: 10px 5px; border-radius: 6px; font-size: 13px; font-weight: bold; min-height: 54px; cursor: pointer; }
        button:active { background: #1a252f; }
        .sub { font-size: 10px; opacity: 0.7; display: block; font-weight: normal; }
    </style>
</head>
<body>

    <div class="m-panel">
        <div class="dist-bar">深部到達まで: <span id="dist-val">10</span>km</div>
        <div class="m-goal"><span id="m-name">依頼読込中...</span><span id="m-count">0/0</span></div>
    </div>

    <div class="s-grid">
        <div class="card" style="border-color: var(--owen);"><div style="color:var(--owen);font-weight:bold;">オーエン</div><div class="stat">HP <span id="o-h">--</span></div><div class="stat">MP <span id="o-m">--</span></div></div>
        <div class="card" style="border-color: var(--cain);"><div style="color:var(--cain);font-weight:bold;">カイン</div><div class="stat">HP <span id="c-h">--</span></div><div class="stat">MP <span id="c-m">--</span></div></div>
    </div>

    <div class="inv-bar"><span>倉庫: <b id="g-inv">0</b></span><span>手荷物: <b id="t-inv">0</b></span><span>甘味: <b id="sw">3</b></span></div>

    <div id="log"></div>

    <div class="controls">
        <button id="btn-safe">慎重に進む<span class="sub">1km進行 / MP消費(小)</span></button>
        <button id="btn-bold">大胆に進む<span class="sub">2km進行 / MP消費(大)</span></button>
        <button id="btn-eat">甘味消費<span class="sub">オーエン回復</span></button>
        <button id="btn-inn">宿屋に戻る<span class="sub">精算・距離リセット</span></button>
    </div>

<script>
window.onload = function() {
    const MASTER_ITEMS = { 'silver_coin': '古い銀貨', 'honey_pot': '蜂蜜酒の瓶', 'magic_crystal': '魔力の欠片' };
    const MISSIONS = [
        { id: 0, target: 'silver_coin', count: 3, label: '古い銀貨を集めろ' },
        { id: 1, target: 'honey_pot', count: 2, label: '蜂蜜酒の瓶を探せ' }
    ];

    let state = {
        o:{h:80,mh:80,m:120,mm:120}, c:{h:120,mh:120,m:50,mm:50},
        globalInv: {}, tempInv: [], sweets: 3, missionIdx: 0, dist: 10, initialDist: 10
    };

    const logEl = document.getElementById('log');
    function addLog(m, c="") {
        const d = document.createElement('div');
        if(c) d.className = c;
        d.innerHTML = m;
        logEl.appendChild(d);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function update() {
        document.getElementById('o-h').innerText = state.o.h + "/" + state.o.mh;
        document.getElementById('o-m').innerText = state.o.m + "/" + state.o.mm;
        document.getElementById('c-h').innerText = state.c.h + "/" + state.c.mh;
        document.getElementById('c-m').innerText = state.c.m + "/" + state.c.mm;
        document.getElementById('sw').innerText = state.sweets;
        document.getElementById('t-inv').innerText = state.tempInv.length;
        document.getElementById('dist-val').innerText = state.dist;
        
        const m = MISSIONS[state.missionIdx] || {label:"全依頼完了", target:"", count:0};
        const current = state.globalInv[m.target] || 0;
        document.getElementById('m-name').innerText = m.label;
        document.getElementById('m-count').innerText = current + "/" + m.count;
        document.getElementById('g-inv').innerText = Object.values(state.globalInv).reduce((a,b)=>a+b,0);
    }

    function resetToInn(isGameOver) {
        if(isGameOver) {
            addLog("【探索失敗】無惨にも敗北し、すべてを失って這い戻った。", "log-dmg");
            state.tempInv = [];
            state.sweets = 0;
            state.c.h = 10; // 瀕死で帰還
        } else {
            // 宿屋に戻る（精算）
            if(state.tempInv.length > 0) {
                const names = state.tempInv.map(id => MASTER_ITEMS[id]).join(", ");
                addLog("【精算】獲得： " + names, "log-sys");
                state.tempInv.forEach(id => { state.globalInv[id] = (state.globalInv[id]||0)+1; });
                state.tempInv = [];
            }
            addLog("【帰還】成果を持ち帰り、体勢を立て直した。", "log-ann");
            state.o.h=state.o.mh; state.o.m=state.o.mm; state.c.h=state.c.mh; state.c.m=state.c.mm; state.sweets=3;
        }
        
        state.dist = state.initialDist; // 距離リセット

        // ミッション達成判定
        const m = MISSIONS[state.missionIdx];
        if(m && (state.globalInv[m.target]||0) >= m.count) {
            addLog("【依頼達成】主人が依頼品を倉庫へ収めた。", "log-ann");
            state.missionIdx++;
        }
        update();
    }

    function gameAction(type) {
        if(state.c.h <= 0 && type !== 'inn') return;

        if(type === 'safe' || type === 'bold') {
            const isB = type === 'bold';
            state.dist = Math.max(0, state.dist - (isB ? 2 : 1));
            state.o.m = Math.max(0, state.o.m - (isB ? 20 : 8));
            addLog(isB ? "オーエンが最短距離を突き進んだ。" : "カインが慎重に道を切り拓いた。");

            // 突発イベント
            if(Math.random() < 0.3) {
                const r = Math.random();
                if(r < 0.5) { state.c.h -= 15; addLog("【因縁】カインが魔物の巣を覗き込み、手痛い傷を負った。", "log-ev"); }
                else { state.o.m -= 15; addLog("【因縁】オーエンがカインの外套に火をつけ、魔力を浪費した。", "log-ev"); }
            }

            // 戦闘とドロップ
            const battleRate = state.dist === 0 ? 1.0 : (isB ? 0.6 : 0.3);
            if(Math.random() < battleRate) {
                const dmg = (state.dist === 0) ? 80 : (isB ? 30 : 12);
                state.c.h -= dmg;
                addLog(`敵の攻撃。カインがオーエンを庇い、血を流した。`, "log-dmg");

                if(state.c.h <= 0) {
                    resetToInn(true);
                    return;
                } else {
                    const ids = Object.keys(MASTER_ITEMS);
                    const loot = ids[Math.floor(Math.random()*ids.length)];
                    state.tempInv.push(loot);
                    addLog(`魔物を排除。[${MASTER_ITEMS[loot]}]を回収。`, "log-sys");
                    if(state.dist === 0) {
                        addLog("【到達】深部の主を撃退した。道は一度閉ざされる。", "log-ann");
                        state.dist = 10; // ボスを倒しても一度リセット
                    }
                }
            }
        } else if(type === 'eat') {
            if(state.sweets > 0) { state.sweets--; state.o.m = state.o.mm; addLog("オーエンは菓子を咀嚼し、魔力を再構成した。"); }
        } else if(type === 'inn') {
            resetToInn(false);
        }
        update();
    }

    // ボタンにイベントを紐付け
    document.getElementById('btn-safe').onclick = () => gameAction('safe');
    document.getElementById('btn-bold').onclick = () => gameAction('bold');
    document.getElementById('btn-eat').onclick = () => gameAction('eat');
    document.getElementById('btn-inn').onclick = () => gameAction('inn');

    update();
    addLog("闇の中、宿命を背負った二人の探索が始まる。");
};
</script>
</body>
</html>